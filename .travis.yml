language: node_js
env:
  global:
  - secure: MhlO5xovg1DvjkxvqTD75yju6kW5hOhZcu8WmMYDJ49GgXk8ij/KVoxlqv552mlgRp510PrinVc+SweWtJwXZPjpbsEfdsdTUEMTo1KVJcHk0CuCxGGSPVXOscqNUzj6SCS4dGuECYBH4xqIvlRrIOTgPCuRF9ZxQ/0noR9XSaXvLIznUGYAl/8l3disNTX/7Gm0PdDS12HTa9xbiDG/WYFO8FZsvVoeUis6sourHn9QUlKSu3CBwlszQb/2KWByVDgoWAlwcXU36djrRMRTRUOxmotqt6NzZKbheNuFHaz3I67gv1vNcdylAucVVJ0i/aXlQsmulTxkqa7IWR0eC4p0r6oy9u+FJ1dm5iLcJO8/E/xxjGYBeGMSY/mgoeCk2Z6gufdUHfxvFgToFncATEifybJXITC5Sw/eHc7ZBx9kV+cwo+ijzWKGFVweWDZV3QJp7LnHqFwNPO4fuwtGBUO2jKi+KM1p6lR0VyRY/bfYqmD3uPVT6JV8luL3gPis319rBuKu3N5lNbfAntz03/rO1UYiw8Rm4JP1+WRXJWf2gvGi1fy/QjeexUkm0BMjnGIJf7gdGSFigpdUeds0fVosl6Tn2/KQR8Pr9CSSUCIsJu4nxueK+YasikXjCObxctV3rRuSa17+9APRuQXDDkXTxu6Mw6yg4HQjlH4OK/g=
  - secure: BYyOQjkpwHukROYCxU7H2xYbF7M0xT8UI7XoWGjJ2TSBwo9xttx2kVuBmbCMGL1Qzv0pCGMaEla0AABzoc9GviN0vyzZbZepBVh2WFYNxVTXfNeMRLrxCIV6My5xqHYZBTadlPdjdq7iAb4u8uKFDCI8MOAHdmJiJmm9rn+AMsyzXk5xbmB1pw2LysegQcDs9Hh3w9r4KltsRadnAP3rXmY2ZIWurpdUGEOLORoABuw6wtkNRYRotgDhwOvjPTE3SEx4j7w2x5ZB2M9+gv2Fnb7zWI/GNTTqB9lLJlTnWUHFRqBpW5NkfN+MZ+fV36/T3uMn70nWH6jfE3kTOULen9Y+/ZJ4NcIt/Esf6QfrkpxFbJ83j4iSlcRd+NsuM1shgsy0Yjb2ehc9WHevOQ0bWJY3N0dH9S7bgPuZNHGyE2kB/TF1PU9yfCkY/4x5EhX+T0V3HHfwTDa7JtNNUc0/TdUSN1oxk6ZqToP2iK4EJaLymikTrOspjGOQVY1QuR3Pk4vz7zITjTrfSp8CBZeZ7H6/mYeZx9k9cRJj1mVq8rLWJ5sfeM/VSKyX6U7LFm7BId8wG4ksfYAsdgLRxCXap7R5YhtRNW57RdLpaXgdZAny0KG2zN1GuuYUImsYH7ghkxEy76rvgONnX3BEHhsA/omOmGszC5C/jf7F2qEBhjI=
  - secure: QrYsjPgzQ4kSAu9oN2mdbsoYBGNi1YBVfSumEXohqz0ellKzlmlJqFz5ffWzK+4TcxPGExbYzPzFj1wTftID9d+GhtB0buhY1V4w4TsxG1d6lPN3E2dizkNmc6VxnaZ5jmoD5UCAlPi6YUcBegRc2PNSRXs0kLk5zM5SC5oHqtQ4QW0Ywc5apedq8BAI6pg1zImNZkhs1tQVeNRD1J8bkgW+A7smDlDK+At5yN7YIsUQ2JTK8ptbrbugxkxiVE0jnkO2fiRyehYXmXS1fzjSqxHqnh8O8BnmASqm+iO7mauD2GQar02u+UPHDJVjksKZxuYasbSZxz1f20N5qm2YZHV6cBJhPJJqW0q9ytrFvI/gQPk8wwo3tP4MCQDkPpQisylSYo0v4AXOeGSf2EsMAyqhJFxLmqj/gHrb3nIprxsHP3tbvXV8ESoXIY75x4yzkybVzvQPThoT9Dy2PaENpOALykL9SW9XYrwf4pCrt5tfgs+A5NGRAUp23Nl8w8QMOAnEBJtABB17FL264mtIkN/uVBUm1wvYXOBVfbmRnmJOZBHvvbksYwc7xJAcKVTTrQ7RPxMNkMAbNFZ3AouvCj8YRPo4uGeAJqG8cdFDYnqBkIXCR3Z+QHeP0XPiFrJRtpKj2aBW+UKSCyrevnHRbgm+Qn0joJBZIKbsNQkg1OI=
  - secure: SnB0027Fy+OOcB3cz4fWOrX84x8tOnaEYURanLs2ilVY87Fb5UvMJ15eiDEATaNNvvfbphGKzxaoSlf2Krr0cGvSyVTgDs37x3xpfx1dUP0Pn00akXXeHxWur33VYMSugBtHSWMc+6tXrEYXgvdBdIE68r81ygKfpnsIh2Z7rgtazm6mu/cZ/XNViqv7i8mP40fKKwQsrr2ieaImyNHk+FK/6uwUJI25Idggtvki3V71J09HL2RJYkx1udhxNoeqoRnkOIsqVr5MEY2ta7WmQ1Gt35OVswQkAdSju9CLBJQLyNNQ05ixz6EE0tgFB/lGco4ta/gW2rS6PnxeUR7rPZ8frEV41VPn07EGvniz+hhiz5RNI4jDwDNDd/cmzbiuRq0uRpl3xi/vKsvU92Fg4ZJTcpHlvp0Re4IFKi0to4bovfI0jIrGQJ6hA2SYxx505RtwDq6WLWvDoGLJCXV5dUw7+pRXiUolj1gCQNEGNO23QMkp7GT8XABVCj2IdLSBZNxEHL6nf0w7iHSYPx/CVs/Y18NuXod5gAs4vsaQEautKcJVtBcdOejsPbUOJafsj+cI7I4QBkgOAIsne83X2tRUdSoajejd02Q30bmlsTq/IQUyTqeVa2D44OW9leUQm1aXMPye5LKj+mOz0jIJJkh8Y315zhlbkOyB9gam0q4=
node_js:
- 10.9.0
cache: yarn
jobs:
  include:
  - stage: precache
    script:
    - cd backend && yarn && cd ..
    - cd frontend && yarn && cd ..
    - cd e2e && yarn
  - stage: tests
    install: cd backend && yarn
    script: yarn test:all_coverage
    after_success: yarn coveralls
  - install:
    - docker-compose build
    - cd e2e && yarn
    before_script: cd .. && docker-compose up -d
    script: cd e2e && yarn cypress:run
    after_script: cd .. && docker-compose down
  - install: cd frontend && yarn
    script: yarn test:all_coverage
    after_success: yarn coveralls
  - stage: build
    services:
    - docker
    env:
    - TAG=graffic/nanocorp:app
    script:
    - docker build --build-arg NANOCORP_FRONTEND_API_URL=/graphql -t $TAG .
    - docker login -u $DOCKER_USER -p $DOCKER_PASS
    - docker push $TAG
  - services:
    - docker
    env:
    - TAG=graffic/nanocorp:db
    script:
    - cd db
    - docker build -t $TAG .
    - docker login -u $DOCKER_USER -p $DOCKER_PASS
    - docker push $TAG
  - stage: deploy
    script: deploy/travis-deploy.sh
stages:
- name: precache
- name: tests
- name: build
  if: branch = master
- name: deploy
  if: branch = master
